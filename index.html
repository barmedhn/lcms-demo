<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LCMS — Law Firm Case Management System</title>
  <meta name="description" content="LCMS modular SPA: Cases, Documents, Client Portal, Workflow, Reports, Proposals, Settings."/>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='18' fill='%231b1f27'/><text x='50' y='58' font-size='52' text-anchor='middle' fill='%23fff' font-family='Arial, Helvetica, sans-serif'>⚖️</text></svg>">
  <link rel="stylesheet" href="./assets/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">⚖️</div>
      <div>
        <h1>LCMS</h1>
        <div class="note">Modular Case Management</div>
      </div>
    </div>
    <div class="nav" id="nav">
      <button data-view="dashboard" class="active">🏠 Dashboard</button>
      <button data-view="cases">📂 Cases</button>
      <button data-view="documents">📝 Document Writing</button>
      <button data-view="clientPortal">👤 Client Portal</button>
      <button data-view="workflow">🔁 Workflow</button>
      <button data-view="reports">📊 Reports</button>
      <button data-view="proposals">📄 Service Proposals</button>
      <button data-view="settings">⚙️ Settings</button>
    </div>
    <div style="margin-top:auto;padding:14px; border-top:1px solid var(--border)" class="note">
      ⌨️ Tips: <span class="kbd">/</span> search • <span class="kbd">N</span> new case • <span class="kbd">G</span> go to module
    </div>
  </aside>

  <!-- MAIN -->
  <main class="content">
    <div class="topbar">
      <div class="search">
        🔎 <input id="globalSearch" type="search" placeholder="Search cases, clients, docs…"/>
      </div>
      <div class="user">
        <span id="brandNameTop" class="note">Your firm</span>
        <div class="avatar" title="Admin"></div>
      </div>
    </div>

    <!-- VIEWS (same markup as the single-file version) -->
    <section id="view-dashboard" class="grid two">
      <div class="card">
        <h3>At a glance</h3>
        <div class="grid three">
          <div class="card"><div class="note">Open cases</div><div id="statOpen" style="font-size:28px;font-weight:700">0</div></div>
          <div class="card"><div class="note">Deadlines (next 7 days)</div><div id="statDeadlines" style="font-size:28px;font-weight:700">0</div></div>
          <div class="card"><div class="note">Proposals pending</div><div id="statProposals" style="font-size:28px;font-weight:700">0</div></div>
        </div>
        <div class="hr"></div>
        <div class="toolbar">
          <button class="btn" onclick="window.app.openNewCase()">➕ New Case</button>
          <button class="btn secondary" onclick="window.app.openView('reports')">View Reports</button>
        </div>
        <table class="table" id="tblUpcoming">
          <thead><tr><th>When</th><th>Case</th><th>Task/Deadline</th><th>Assignee</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h3>Workflow progress</h3>
        <div class="progress"><span id="progressAll" style="width:0%"></span></div>
        <div class="note" id="progressAllText">0% done across active cases</div>
        <canvas id="chartCases" style="margin-top:14px; background:#0c1426; border:1px solid var(--border); border-radius:12px; padding:10px"></canvas>
      </div>
    </section>

    <section id="view-cases" class="grid">
      <div class="card">
        <div class="row" style="align-items:flex-end">
          <div class="field"><label>Filter by status</label>
            <select id="caseFilterStatus"><option value="">All</option><option>Open</option><option>On Hold</option><option>At Risk</option><option>Closed</option></select>
          </div>
          <div class="field"><label>Filter by type</label>
            <select id="caseFilterType"><option value="">All</option><option>Administrative</option><option>Civil</option><option>Corporate</option><option>Immigration</option></select>
          </div>
          <button class="btn right" id="btnNewCase">➕ New Case</button>
        </div>
        <div class="hr"></div>
        <table class="table" id="tblCases">
          <thead><tr><th>Case #</th><th>Client</th><th>Type</th><th>Assigned</th><th>Next Deadline</th><th>Status</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h3>Case editor</h3>
        <div class="split">
          <div>
            <div class="row">
              <div class="field"><label>Case #</label><input id="caseId"></div>
              <div class="field"><label>Client</label><input id="caseClient"></div>
            </div>
            <div class="row">
              <div class="field"><label>Type</label>
                <select id="caseType"><option>Administrative</option><option>Civil</option><option>Corporate</option><option>Immigration</option></select>
              </div>
              <div class="field"><label>Assignee (Lawyer)</label><input id="caseAssignee" list="lawyersList" placeholder="e.g., J. Barahona"></div>
              <datalist id="lawyersList"></datalist>
            </div>
            <div class="row">
              <div class="field"><label>Status</label>
                <select id="caseStatus"><option>Open</option><option>On Hold</option><option>At Risk</option><option>Closed</option></select>
              </div>
              <div class="field"><label>Next Deadline</label><input type="date" id="caseDeadline"></div>
            </div>
            <div class="field"><label>Notes / History</label><textarea id="caseNotes" rows="6" placeholder="Court filings, calls, meetings…"></textarea></div>
            <div class="toolbar">
              <button class="btn" id="btnSaveCase">💾 Save Case</button>
              <button class="btn secondary" id="btnNew">New</button>
              <button class="btn danger" id="btnDelete">🗑️ Delete</button>
            </div>
          </div>
          <div>
            <h4>Tasks for this case</h4>
            <div class="row">
              <div class="field"><label>Task</label><input id="taskTitle"></div>
              <div class="field"><label>Due</label><input type="date" id="taskDue"></div>
              <div class="field"><label>Owner</label><input id="taskOwner" list="lawyersList"></div>
              <button class="btn" id="btnAddTask">➕ Add</button>
            </div>
            <table class="table" id="tblTasks"><thead><tr><th>Task</th><th>Due</th><th>Owner</th><th>Done</th><th></th></tr></thead><tbody></tbody></table>
            <div class="hr"></div>
            <h4>Communication log</h4>
            <div class="row">
              <div class="field"><label>Entry</label><input id="commText" placeholder="Call w/ client…"></div>
              <button class="btn" id="btnLog">➕ Log</button>
            </div>
            <table class="table" id="tblComm"><thead><tr><th>When</th><th>Entry</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <section id="view-documents" class="grid">
      <div class="card">
        <div class="toolbar">
          <select id="docTemplateSelect"></select>
          <button class="btn" id="btnLoadTemplate">Load Template</button>
          <button class="btn secondary" id="btnSaveVersion">Save Version</button>
          <button class="btn ghost" id="btnExportDoc">Export .HTML</button>
        </div>
        <div id="docEditor" contenteditable="true" style="min-height:260px;background:#0b152a;border:1px solid var(--border);border-radius:12px;padding:14px; line-height:1.6"></div>
        <div class="note" style="margin-top:6px">Rich text editor (bold/italic/links via native shortcuts). Use the toolbar to manage templates and versions.</div>
        <div class="hr"></div>
        <h4>Versions</h4>
        <ul id="docVersions" class="note"></ul>
      </div>
      <div class="card">
        <h3>Share / QR</h3>
        <div id="qrcode" style="background:#0b152a;border:1px dashed var(--border); border-radius:12px; padding:20px; display:grid; place-items:center; min-height:220px"></div>
        <div class="toolbar">
          <input id="qrText" class="field" placeholder="Text / URL to encode" style="flex:1">
          <button class="btn" id="btnMakeQR">Generate QR</button>
        </div>
      </div>
    </section>

    <section id="view-clientPortal" class="grid">
      <div class="card">
        <h3>Client view (read‑only)</h3>
        <div class="row">
          <div class="field"><label>Client</label><input id="portalClient" placeholder="e.g., Acme Ltd"></div>
          <button class="btn" id="btnShowPortal">Show</button>
        </div>
        <div id="portalOutput"></div>
      </div>
      <div class="card">
        <h3>Secure messages</h3>
        <div class="row">
          <div class="field"><label>To (Client)</label><input id="msgTo"></div>
          <div class="field"><label>Message</label><input id="msgBody"></div>
          <button class="btn" id="btnSendMsg">Send</button>
        </div>
        <table class="table" id="tblMsgs"><thead><tr><th>When</th><th>To</th><th>Message</th></tr></thead><tbody></tbody></table>
        <div class="note">(Demo) Messages are stored locally; replace with server‑side messaging for production.</div>
      </div>
      <div class="card">
        <h3>Client uploads</h3>
        <div class="row">
          <input type="file" id="clientUpload" multiple>
          <button class="btn" id="btnStoreUpload">Store Meta</button>
        </div>
        <table class="table" id="tblUploads"><thead><tr><th>Client</th><th>Filename</th><th>Size</th><th>When</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="view-workflow" class="grid">
      <div class="card">
        <div class="toolbar">
          <div class="field"><label>Workflow name</label><input id="wfName" placeholder="e.g., Administrative Appeal"></div>
          <div class="field"><label>Stages (comma‑separated)</label><input id="wfStages" placeholder="Intake, Draft, File, Hearing, Judgment"></div>
          <button class="btn" id="btnSaveWorkflow">💾 Save Workflow</button>
        </div>
        <table class="table" id="tblWorkflows"><thead><tr><th>Name</th><th>Stages</th><th>Assign to Case</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3>Apply to case</h3>
        <div class="row">
          <div class="field"><label>Case #</label><input id="wfCase"></div>
          <div class="field"><label>Workflow</label><select id="wfSelect"></select></div>
          <button class="btn" id="btnApplyWorkflow">Apply</button>
        </div>
        <table class="table" id="tblCaseStages"><thead><tr><th>Case #</th><th>Stage</th><th>Done?</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="view-reports" class="grid two">
      <div class="card">
        <div class="row">
          <div class="field"><label>Status Filter</label>
            <select id="rStatus"><option value="">Any</option><option>Open</option><option>On Hold</option><option>At Risk</option><option>Closed</option></select></div>
          <div class="field"><label>Assignee Filter</label><input id="rAssignee" placeholder="Optional"></div>
          <button class="btn right" id="btnExportCSV">Export CSV</button>
        </div>
        <table class="table" id="tblReport"><thead><tr><th>Case #</th><th>Client</th><th>Type</th><th>Status</th><th>Assignee</th><th>Next Deadline</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3>Case Performance</h3>
        <canvas id="chartPerf"></canvas>
      </div>
    </section>

    <section id="view-proposals" class="grid">
      <div class="card">
        <div class="toolbar">
          <div class="field"><label>Client</label><input id="ppClient"></div>
          <div class="field"><label>Title</label><input id="ppTitle" placeholder="Service Proposal"></div>
          <div class="field"><label>Subject / Asunto</label><input id="ppSubject" placeholder="Propuesta de servicios profesionales …"></div>
          <div class="field"><label>Value (HNL/USD)</label><input id="ppValue" type="number" step="0.01"></div>
          <div class="field"><label>Status</label>
            <select id="ppStatus"><option>Draft</option><option>Sent</option><option>Accepted</option><option>Declined</option></select>
          </div>
          <button class="btn" id="btnSaveProposal">💾 Save</button>
          <button class="btn ghost" id="btnRefreshProposals">Refresh</button>
          <button class="btn" id="btnPreviewProposal">👁️ Preview</button>
          <button class="btn secondary" id="btnExportPropHTML">Export .HTML</button>
          <button class="btn warn" id="btnPrintProposal">🖨️ Print / PDF</button>
        </div>

        <details class="card" style="margin:8px 0">
          <summary style="cursor:pointer">Template Fields (BARMED®)</summary>
          <div class="grid two" style="margin-top:10px">
            <div class="field"><label>Client Country / País</label><input id="ppCountry" placeholder="República del Perú"></div>
            <div class="field"><label>Primary Phone</label><input id="ppPhone" placeholder="+504 9557 6771"></div>
            <div class="field"><label>Expediente # (SGJD/RNP)</label><input id="ppExpediente" placeholder="V-12012024-7"></div>
            <div class="field"><label>Total in Words</label><input id="ppTotalWords" placeholder="QUINIENTOS CINCUENTA DÓLARES ESTADOUNIDENSES CON 00/100"></div>
            <div class="field"><label>Milestone A (desc)</label><input id="ppA" placeholder="Poder + Auténtica + Personamiento + Estudio"></div>
            <div class="field"><label>Amount A</label><input id="ppAmtA" type="number" step="0.01" placeholder="150"></div>
            <div class="field"><label>Milestone B (desc)</label><input id="ppB" placeholder="Rectificación de apellido en SGJD"></div>
            <div class="field"><label>Amount B</label><input id="ppAmtB" type="number" step="0.01" placeholder="400"></div>
            <div class="field"><label>Schedule 1 (date)</label><input id="ppS1" type="date"></div>
            <div class="field"><label>Schedule 1 (desc)</label><input id="ppS1d" placeholder="Pago inicial de 'A' y preparación de poder"></div>
            <div class="field"><label>Schedule 2 (date)</label><input id="ppS2" type="date"></div>
            <div class="field"><label>Schedule 2 (desc)</label><input id="ppS2d" placeholder="Personamiento en SGJD"></div>
            <div class="field"><label>Schedule 3 (date)</label><input id="ppS3" type="date"></div>
            <div class="field"><label>Schedule 3 (desc)</label><input id="ppS3d" placeholder="Revisión de expediente y redacción de informe"></div>
            <div class="field"><label>Validity (deadline)</label><input id="ppValidUntil" type="datetime-local"></div>
            <div class="field"><label>Bank (display)</label><input id="ppBank" placeholder="Banco de Occidente — JAIME F. BARAHONA IRIAS — 21-443-000305-9"></div>
          </div>
        </details>

        <div class="field"><label>Proposal Body (additional notes)</label><textarea id="ppBody" rows="6" placeholder="Scope, deliverables, timeline, terms…"></textarea></div>
        <div class="hr"></div>
        <table class="table" id="tblProposals"><thead><tr><th>#</th><th>Client</th><th>Title</th><th>Value</th><th>Status</th><th>Updated</th><th>QR</th><th></th></tr></thead><tbody></tbody></table>
      </div>

      <div class="card">
        <h3>Live Preview</h3>
        <div id="proposalPreview" style="background:#0b152a;border:1px solid var(--border); border-radius:12px; padding:16px; min-height:320px; overflow:auto"></div>
      </div>
    </section>

    <section id="view-settings" class="grid two">
      <div class="card">
        <h3>Users & Roles</h3>
        <div class="row">
          <div class="field"><label>Full name</label><input id="uName"></div>
          <div class="field"><label>Role</label>
            <select id="uRole"><option>Admin</option><option>Lawyer</option><option>Paralegal</option><option>Client</option></select>
          </div>
          <button class="btn" id="btnAddUser">➕ Add</button>
        </div>
        <table class="table" id="tblUsers"><thead><tr><th>Name</th><th>Role</th><th></th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3>Preferences & Branding</h3>
        <div class="field"><label>Brand / Firm name</label><input id="brandName"></div>
        <div class="row">
          <div class="field"><label>Notification lead (days)</label><input id="notifyDays" type="number" min="0" value="5"></div>
          <div class="field"><label>Timezone</label><input id="tz" placeholder="America/Tegucigalpa"></div>
        </div>
        <div class="row">
          <input type="file" id="brandLogo" accept="image/*">
          <button class="btn" id="btnSaveBranding">Save Branding</button>
        </div>
        <div class="hr"></div>
        <div class="toolbar">
          <button class="btn warn" id="btnExportBackup">⬇️ Export Backup (JSON)</button>
          <input type="file" id="restoreFile" accept="application/json">
          <button class="btn secondary" id="btnRestoreBackup">Restore</button>
          <button class="btn danger right" id="btnFactoryReset">Factory Reset</button>
        </div>
        <div class="note">Data is stored in your browser (localStorage). Connect to a backend for multi‑user, secure persistence.</div>
      </div>
    </section>
  </main>

  <!-- App bootstrap -->
  <script type="module">
    import * as Utils from './modules/utils.js';
    import * as DB from './modules/db.js';
    import * as Router from './modules/router.js';
    import * as Charts from './modules/charts.js';
    import * as Cases from './modules/cases.js';
    import * as Docs from './modules/documents.js';
    import * as Portal from './modules/client-portal.js';
    import * as Workflow from './modules/workflow.js';
    import * as Reports from './modules/reports.js';
    import * as Proposals from './modules/proposals.js';
    import * as Settings from './modules/settings.js';

    // expose minimal app API for button inline handlers that we kept
    window.app = {
      openView: Router.openView,
      openNewCase: Cases.openNewCase,
    };

    // init
    DB.initDB();
    Router.mount();
    Cases.mount();
    Docs.mount();
    Portal.mount();
    Workflow.mount();
    Reports.mount();
    Proposals.mount();
    Settings.mount();
    Reports.refreshStats(); // initial stats
  </script>
</body>
</html>
